{% extends "layout.html" %}
{% block content %}
<div id="post_box">
    <form method="post" action="/book/search">
        <input type="text" id="search_text" name="search_text" placeholder="제목/작가를 입력하세요">
        <button type="submit">search</button>
    </form>
    <form method="post" action="/post/{{ user.id }}/newPost">
        <div id="result_list">
        </div>
        <div id="book_box" style="border:1px gray solid;">
            <img id="book_img">
            <h1 id="book_title"></h1>
            <h1 id="book_author"></h1>
        </div> 
        <input type="text" name="post_book_id" id="post_book_id"> 
        <textarea name="post_title" id="" cols="30" rows="10" maxlength="40"></textarea>
        <textarea name="post_free_text" id="" cols="30" rows="10" maxlength="200"></textarea>
        <button type="submit">제출</button>
    </form> 
</div>
{% endblock %}

{% block script %}
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        const socket= io.connect('http://localhost:8080/post', { path: '/socket.io'});

        
        socket.on('connect', function () {
            socket.on('searchBooks', async function (data) {
                const result_list_div= document.getElementById('result_list');
                while ( result_list_div.hasChildNodes() ) { result_list_div.removeChild( result_list_div.firstChild ); }
                const data_js= JSON.parse(data);
            
                alert(data_js.root.result.item[0]);
                let count=0;
                for(let i=0; i<data_js.root.result.item.length; i++) {
                    if(count==5) break; 
                    const item= data_js.root.result.item[i];
                    const div= document.createElement('div');
                    const img= document.createElement('img');
                    const h1_1= document.createElement('h5');
                    const h1_2= document.createElement('h5');
                    const regex = /[^0-9]/g;				// 숫자가 아닌 문자열을 선택하는 정규식
                    const title=item.title_info._cdata;
                    const author= item.author_info._cdata;
                    const kdc= item.kdc_code_1s._cdata;
                    const isbn= item.isbn._cdata.split(" ")[0].replace(regex, "");
                    if(!isbn){
                        continue;
                    } else console.log('isbn: ', isbn)
                    img.onerror= "this.style.display='none'";
                    let img_url;
                    try{
                        img_url= await promise_img(isbn, item.control_no._text.replace(/[^0-9]/g, "").substr(0, 4), item.detail_link._cdata.split(/\&|\=/)[1], item.control_no._text).catch((err)=>{});
                        //https://cover.nl.go.kr/kolis_on/2015/CNTS-00073919725_thumbnail.jpg 날짜 다르고 kolis_on임
                        //https://cover.nl.go.kr/kolis/20091215/CNTS-00073919725_thumbnail.jpg 원래꺼
                    } catch (err) { img_url= "http://localhost:8080/public/iconBook.png" }
                    console.log('img url:', img_url);
                    img.src= img_url;
                    img.style= "width:100px; height:100px;";
                    h1_1.textContent= title? title : "?";
                    h1_2.textContent= author? author : "?";

                    div.appendChild(img);
                    div.appendChild(h1_1);
                    div.appendChild(h1_2);
                    div.onclick= function () { selectBook(title, author, kdc, isbn, img_url)};
                    div.style= "cursor:pointer";
                    result_list_div.appendChild(div);
                    count++;
                    console.log(i, count);
                }
                
            })
        });
        
        function selectBook(title, author, kdc, isbn, img) {
            axios.post(`/book/admin/${isbn}/${kdc}`, { title, author, img }).then((res)=>{ 
                if(res.data.code!=200) {
                    console.log('책이 제대로 등록되지 않았음', res.data.message);
                }
                else {
                    const book= res.data.payload;
                    alert("select: " + book.title);
                    document.getElementById('book_title').textContent= book.title;
                    document.getElementById('book_author').textContent= book.author;
                    document.getElementById('book_img').src= book.title_url;
                    document.getElementById('post_book_id').value= book.id;
                }
                
            }).catch((err)=>{
                console.log(err);
            });
        }

        const promise_img = function (isbn, year, viewkey, controlno) {
            return new Promise((resolve, reject) => {
                axios.post(`/book/image/${isbn}`, { year, viewkey, controlno}).then((res)=>{
                if(res.data.code==200) {
                    resolve(res.data.imgurl);
                }
                else 
                    resolve("http://localhost:8080/public/iconBook.png");
                }).catch((err)=>{ console.log(err); resolve("http://localhost:8080/public/iconBook.png"); });
            }).catch((error) => {
                return error;
            });
        };
    </script>
{% endblock %}