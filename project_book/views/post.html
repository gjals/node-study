{% extends "layout.html" %}
{% block content %}
<div class="post_all">
    <div class="post_left">
        <div class="search_form">
            <form method="post" action="/book/search" id="book_search_box">
                <input type="text" id="search_text" name="search_text" placeholder="선택할 책의 제목/작가를 입력하세요">
                <button id="search_btn" type="submit">검색</button>
            </form>
        </div>
        <div class="result_table">
            <div id="result_list">
            </div>
        </div>
    </div>
    <div class="post_right">
        <div class="post_form">
            <form method="post" action="/post/{{ user.id }}/newPost" id="post_box">
                <div id="book_box">
                    <img id="book_img">
                    <p id="book_title"></p>
                    <p id="book_author"></p>
                </div> 
                <input type="hidden" name="post_book_id" id="post_book_id"> 
                <textarea name="post_title" id="post_write_title" cols="10" rows="40" maxlength="40"></textarea>
                <textarea name="post_free_text" id="post_write_text" cols="30" rows="30" maxlength="500"></textarea>
                <button type="submit" id="post_btn"></button>
            </form> 
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        const socket= io.connect('http://localhost:8080/post', { path: '/socket.io'});
        socket.on('connect', function () {
            socket.on('searchBooks', async function (data) {
                const result_list_div= document.getElementById('result_list');
                while ( result_list_div.hasChildNodes() ) { result_list_div.removeChild( result_list_div.firstChild ); }
                const data_js= JSON.parse(data);
            
                //alert(data_js.root.result.item[0]);
                let count=0;
                for(let i=0; i<data_js.root.result.item.length; i++) {
                    if(count==5) break; 
                    const item= data_js.root.result.item[i];
                    const div= document.createElement('div');
                    const img= document.createElement('img');
                    const h1_1= document.createElement('p');
                    const h1_2= document.createElement('p');
                    const regex = /[^0-9]/g;				// 숫자가 아닌 문자열을 선택하는 정규식
                    const title=item.title_info._cdata;
                    const author= item.author_info._cdata;
                    const kdc= item.kdc_code_1s._cdata;
                    let isbn= null;
                    if(item.isbn._cdata)
                        isbn= item.isbn._cdata.split(" ")[0].replace(regex, "");
                    
                    img.onerror= "this.style.display='none'";
                    let img_url;
                    try{
                        img_url= await promise_img(isbn, item.control_no._text.replace(/[^0-9]/g, "").substr(0, 4), item.detail_link._cdata.split(/\&|\=/)[1], item.control_no._text).catch((err)=>{});
                        //https://cover.nl.go.kr/kolis_on/2015/CNTS-00073919725_thumbnail.jpg 날짜 다르고 kolis_on임
                        //https://cover.nl.go.kr/kolis/20091215/CNTS-00073919725_thumbnail.jpg 원래꺼
                    } catch (err) { img_url= "http://localhost:8080/public/iconBook.png" }
                    //console.log('img url:', img_url);
                    img.src= img_url;
                    img.style= "width:80px; height:100px;";
                    h1_1.textContent= title? title : "?";
                    h1_2.textContent= author? author : "?";

                    div.appendChild(img);
                    div.appendChild(h1_1);
                    div.appendChild(h1_2);
                    div.onclick= function () { selectBook(title, author, kdc, img_url)};
                    div.style= "cursor:pointer";
                    result_list_div.appendChild(div);
                    count++;
                    console.log(i, count);
                }
                
            })
        });
        
        function selectBook(title, author, kdc, img) {
            axios.post(`/book/admin/${kdc}`, { title, author, img }).then((res)=>{ 
                if(res.data.code!=200) {
                    console.log('책이 제대로 등록되지 않았음', res.data.message);
                }
                else {
                    const book= res.data.payload;
                    alert("책이 선택되었습니다");
                    document.getElementById('book_title').textContent= book.title;
                    document.getElementById('book_author').textContent= book.author;
                    document.getElementById('book_img').src= book.title_url;
                    document.getElementById('post_book_id').value= book.id;
                }
                
            }).catch((err)=>{
                console.log(err);
            });
        }

        const promise_img = function (isbn, year, viewkey, controlno) {
            return new Promise((resolve, reject) => {
                axios.post(`/book/image`, { isbn, year, viewkey, controlno}).then((res)=>{
                if(res.data.code==200) {
                    resolve(res.data.imgurl);
                }
                else 
                    resolve("http://localhost:8080/public/iconBook.png");
                }).catch((err)=>{ console.log(err); resolve("http://localhost:8080/public/iconBook.png"); });
            }).catch((error) => {
                return error;
            });
        };

        document.getElementById('post_box').addEventListener('submit', (e)=>{
            e.preventDefault();
            const title= e.target.post_title.value;
            const free_text= e.target.post_free_text.value;
            const bookid= e.target.post_book_id.value;
            axios.post('/post/{{user.id}}/newPost', { title, free_text, bookid }).then((res)=>{
                if(res.data.code==200) {
                    alert(res.data.message);
                    location.href='/';
                }
                else {
                    alert(res.data.message);
                }
            }).catch((err)=>{ console.log(err); });
        })
    </script>
{% endblock %}