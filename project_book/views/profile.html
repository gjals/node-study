{% extends "layout.html" %}

{% block content %}
{% if user %}
<div class="first_profile">
    <div id="profile_logout">
        <span id="profile_nick">{{ user.nick }} 님</span><a id="profile-logout" href="/auth/logout">로그아웃</a>
    </div>
    <form class="nick_update_form" action="#"></form>
    <div>
        <table>
            <caption>이름 수정</caption>
            <tr><td>
                <input type="text" placeholder="{{ user.nick }}" name="user_nick" id="nick_text">
            </td></tr>
        </table>
        <button type="submit" id="profile_btn">수정</button>
    </div>
    </form>
    {% if user.emailProvider=='local' %}
    <form class="password_update_form" action="#">
        <table>
            <caption>비밀번호 변경</caption>
            <tr><td>
                <input type="password" placeholder="현재 비밀번호" name="user_password_now">
            </td></tr>
            <tr><td>
                <input type="password" placeholder="새 비밀번호" name="user_password_new">
            </td></tr>
            <tr><td>
                <input type="password" placeholder="비밀번호 확인" name="user_password_new_2">
            </td></tr>
        </table>
        <button type="submit" id="profile_btn">수정</button>
    </form>
    {% endif %}
</div>
    {% for post in posts %}
    <div class="post_edit">
    <form id="post_update_form" action="#"> 
        <table>
            <tr>
                <td rowspan="2"><img src="{{post.Book.title_url}}"></td>
                <td>{{ post.Book.title }}</td>
            </tr>
            <tr>
                <td>{{ post.Book.author }}</td>
            </tr>
            <tr>
                <td colspan="2"><textarea name="post_update_title" id="post_title_text" maxlength="40" cols="10" rows="40">{{ post.title }}</textarea></td>
            </tr>
            <tr>
                <td colspan="2"><textarea name="post_update_free_text" id="post_freetext_text" maxlength="500" cols="30" rows="30">{{ post.free_text }}</textarea></td>
            </tr>
        </table>
        <input type="hidden" name="post_id" value="{{ post.id }}">
        <button type="submit">수정</button>
        <button type="button" id="post_remove_btn">삭제</button>
    </form>
    </div>
    {% endfor %}
{% endif %}
{% endblock %}

{% block script %}
    <script>
        document.querySelectorAll('#post_update_form').forEach((element)=>{element.addEventListener('submit', function (e){
            e.preventDefault();
            const title= e.target.post_update_title.value;
            const free_text= e.target.post_update_free_text.value;
            const postid= e.target.post_id.value;
            axios.post(`/post/${postid}/update`, { title, free_text }).then((res)=>{
                alert(res.data.message);
                if(res.data.code==200) {
                    location.href='/profile';
                }
            }).catch((err)=>{ console.log(err); });
        })
    })

    document.querySelector('.nick_update_form').addEventListener('submit', function(e){
        e.preventDefault();
        const nick= e.target.user_nick;
        axios.post(`/user/{{ user.id }}/updateNick`, { nick }).then((res)=>{
            alert(res.data.message);
            if(res.data.code==200)
                location.href="/profile"
        }).catch((err)=>{ console.log(err); })
    })


    document.querySelector('.password_update_form').addEventListener('submit', function(e){
        e.preventDefault();
        if(e.target.user_password_now!='{{ user.password }}') {
            return alert("현재 비밀번호와 다릅니다");
        }
        if(e.target.user_password_new!=e.target.user_password_now_2)
            return alert("비밀번호를 다시 확인해주세요");
        const password= e.target.user_password_new;
        axios.post(`/user/{{ user.id }}/updatePassword`, { password }).then((res)=>{
            alert(res.data.message);
            if(res.data.code==200)
                location.href="/profile"
        }).catch((err)=>{ console.log(err); })
    })

    document.querySelectorAll('#post_remove_btn').forEach((element)=>{
        element.addEventListener('click', function(e) {
            e.preventDefault();
            const data= confirm('정말로 삭제하시겠습니까?');
            if(data) {
                const postid= e.target.parentNode.post_id.value;
                alert(postid);
                axios.post(`/post/${postid}/remove`).then((res)=>{
                alert(res.data.message);
                if(res.data.code==200) {
                    location.href='/profile';
                }
            }).catch((err)=>{ console.log(err); });
            }
        })
    })
    </script>
{% endblock %}