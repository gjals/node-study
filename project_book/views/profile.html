{% extends "layout.html" %}

{% block content %}
{% if user %}
<span>{{ user.nick }} 님</span><a id="profile-logout" href="/auth/logout">로그아웃</a>
<form id="profile_update_form" action="#">
    <input type="text" placeholder="{{ user.nick }}" name="user_nick">
    {% if user.emailProvider=='local' %}
    <input type="password" placeholder="현재 비밀번호" name="user_password_now">
    <input type="password" placeholder="새 비밀번호" name="user_password_new">
    <input type="password" placeholder="비밀번호 확인" name="user_password_new_2">
    <button type="submit">수정</button>
    {% endif %}
</form>

    {% for post in posts %}
        <img src="{{post.Book.title_url}}" style="width: 50px; height: 50px;">
        {{ post.Book.title }}
        {{ post.Book.author }}
        <form id="post_update_form" action="#">
            <input type="hidden" name="post_id" value="{{ post.id }}">
            <input type="text" name="post_update_title" value="{{ post.title }}">
            <input type="text" name="post_update_free_text" value="{{ post.free_text }}">
            <button type="submit">수정</button>
            <button id="post_remove_btn">삭제</button>
        </form>
    {% endfor %}
{% endif %}
{% endblock %}

{% block script %}
    <script>
        document.querySelectorAll('#post_update_form').forEach((element)=>{element.addEventListener('submit', function (e){
            e.preventDefault();
            const title= e.target.post_update_title.value;
            const free_text= e.target.post_update_free_text.value;
            const postid= e.target.post_id.value;
            axios.post(`/post/${postid}/update`, { title, free_text }).then((res)=>{
                alert(res.data.message);
                if(res.data.code==200) {
                    location.href='/profile';
                }
            }).catch((err)=>{ console.log(err); });
        })
    })

    document.querySelector('#profile_update_form').addEventListener('submit', function(e){
        e.preventDefault();
        if(e.target.user_password_now!='{{ user.password }}') {
            return alert("현재 비밀번호와 다릅니다");
        }
        if(e.target.user_password_new!=e.target.user_password_now_2)
            return alert("비밀번호를 다시 확인해주세요");
        const password= e.target.user_password_new;
        axios.post(`/post/{{ user.id }}/updatePassword`, { password }).then((res)=>{
            alert(res.data.message);
            if(res.data.code==200)
                location.href="/profile"
        }).catch((err)=>{ console.log(err); })
    })

    document.querySelectorAll('#post_remove_btn').forEach((element)=>{
        element.addEventListener('click', function(e) {
            e.preventDefault();
            const data= confirm('정말로 삭제?');
            if(data) {
                const postid= e.target.parentNode.post_id.value;
                alert(postid);
                axios.post(`/post/${postid}/remove`).then((res)=>{
                alert(res.data.message);
                if(res.data.code==200) {
                    location.href='/profile';
                }
            }).catch((err)=>{ console.log(err); });
            }
        })
    })
    </script>
{% endblock %}